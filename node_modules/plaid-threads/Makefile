

NODE = node
NODE_SASS_OPTS = --output-style compressed
NODE_SASS = node_modules/.bin/node-sass $(NODE_SASS_OPTS)
NODE_AUTOPREFIXER = node_modules/.bin/postcss --use autoprefixer -o
HANDLEBARS = $(NODE) node_modules/.bin/handlebars
NPM_ENV_VARS = npm_config_registry=https://npm.plaid.com
NPM = $(NPM_ENV_VARS) npm
NODE_SASS = node_modules/.bin/node-sass $(NODE_SASS_OPTS)
NODE_AUTOPREFIXER = node_modules/.bin/postcss --use autoprefixer -o
SASS_LINT = node_modules/.bin/sass-lint
XYZ = $(NPM_ENV_VARS) node_modules/.bin/xyz --repo git@github.plaid.com:plaid/threads.git --script "node ./build.js"

SCSS_FILES      = $(shell find lib -name '*.scss' -not -path 'lib/vendor/*')
SRC             = $(JS_FILES) $(JSX_FILES)
LINT_FILES      = $(SRC)


.PHONY: build
build: clean
	@$(NODE) ./build.js
	@cp docs/favicon.ico build/favicon.ico

.PHONY: build-css
build-css: clean
	@mkdir -p build
	@$(NODE_SASS) lib/all.scss > build/threads.css
	@$(NODE_AUTOPREFIXER) build/threads.css build/threads.css

.PHONY: clean
clean:
	@rm -rf build

.PHONY: deploy
deploy:
	@./scripts/deploy

.PHONY: deploy-threads-css
deploy-threads-css:
	@./scripts/deploy-css-cdn

.PHONY: lint
lint:
	@$(SASS_LINT) -vq -- $(SCSS_FILES)

.PHONY: release-major release-minor release-patch
release-major release-minor release-patch:
	@$(XYZ) --increment $(@:release-%=%)

.PHONY: setup
setup: setup-hooks setup-dependencies

.PHONY: setup-dependencies
setup-dependencies:
	@$(NPM) install

.PHONY: setup-hooks
setup-hooks:
	@chmod oug+x githooks/*
	@cp githooks/* .git/hooks/

.PHONY: watch
watch: clean
	@$(NODE) ./watch.js
	@cp docs/favicon.ico build/favicon.ico
